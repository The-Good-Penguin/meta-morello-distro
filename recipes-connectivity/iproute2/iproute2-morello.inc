SUMMARY = "TCP / IP networking and traffic control utilities"
DESCRIPTION = "Iproute2 is a collection of utilities for controlling \
TCP / IP networking and traffic control in Linux.  Of the utilities ip \
and tc are the most important.  ip controls IPv4 and IPv6 \
configuration and tc stands for traffic control."
HOMEPAGE = "http://www.linuxfoundation.org/collaborate/workgroups/networking/iproute2"
SECTION = "base"
LICENSE = "GPL-2.0-or-later"
LIC_FILES_CHKSUM = "file://COPYING;md5=eb723b61539feef013de476e68b5c50a \
                    file://ip/ip.c;beginline=3;endline=8;md5=689d691d0410a4b64d3899f8d6e31817"

inherit update-alternatives bash-completion pkgconfig pure-cap-kheaders
# inherit purecap-sysroot

DEPENDS = "flex-native bison-native iptables-morello libcap-ng"
#DEPENDS += " libmnl-morello"
# DEPENDS += " musl"

TOOLCHAIN = "${MORELLO_TOOLCHAIN}"

CLEANBROKEN = "1"

PACKAGECONFIG ??= "tipc elf devlink"
PACKAGECONFIG[tipc] = ",,libmnl-morello,"
PACKAGECONFIG[elf] = ",,elfutils-morello,"
PACKAGECONFIG[devlink] = ",,libmnl-morello,"
PACKAGECONFIG[rdma] = ",,libmnl-morello,"
#PACKAGECONFIG[libcap] = ",false,libmnl-morello,"

IPROUTE2_MAKE_SUBDIRS = "lib tc ip bridge misc genl ${@bb.utils.filter('PACKAGECONFIG', 'devlink tipc rdma', d)}"

EXTRA_OEMAKE = "\
    CC='${CC}' \
    KERNEL_INCLUDE=${STAGING_DIR_TARGET}${PURECAP_SYSROOT_DIR}${prefix}/src/linux-headers-morello/include \
    DOCDIR=${docdir}/iproute2 \
    SUBDIRS='${IPROUTE2_MAKE_SUBDIRS}' \
    SBINDIR='${base_sbindir}' \
    LIBDIR='${libdir}' \
"

S = "${WORKDIR}/${PN_DL}-${PV}"

do_configure() {
     sh configure --include_dir=${STAGING_DIR_TARGET}${PURECAP_SYSROOT_DIR}${prefix}/src/linux-headers-morello/include
#    # Explicitly disable ATM support
     sed -i -e '/TC_CONFIG_ATM/d' config.mk
#    # possibly the configure script is broken because all the test programs
#    # generated use this define __GNU_SRC which presumably isnt available?
#    # hack to turn off libcap, not in configure options... their script is
#    # not generated by autotools.
     sed -i 's/^HAVE_CAP:=y$/HAVE_CAP:=n/' config.mk
     sed -i 's/^CFLAGS += -DHAVE_LIBCAP//' config.mk
     sed -i 's/^LDLIBS += -lcap//' config.mk
#    # for some reason setns test fails in configure. Hack set it here as it is present.
     echo "IP_CONFIG_SETNS:=y" >> config.mk
     echo "CFLAGS += -DHAVE_SETNS" >> config.mk
#    # have handle AT also wrong from running the configuration file...
     echo "CFLAGS += -DHAVE_HANDLE_AT" >> config.mk

    # iproute2 has sanitized kernel headers included in its source tarball. We need to bin this off..
    sed -i 's/CFLAGS := $(WFLAGS) $(CCOPTS) -I..\/include -I..\/include\/uapi $(DEFINES) $(CFLAGS)/CFLAGS := $(WFLAGS) $(CCOPTS) -I..\/include $(DEFINES) $(CFLAGS)/' Makefile

}

do_install () {
    oe_runmake DESTDIR=${D}${PURECAP_SYSROOT_DIR} install
    install -d ${D}${PURECAP_SYSROOT_DIR}${datadir}
    install -d ${D}${PURECAP_SYSROOT_DIR}${base_sbindir}
    cp ${D}${PURECAP_SYSROOT_DIR}${base_sbindir}/ip ${D}${PURECAP_SYSROOT_DIR}${base_sbindir}/ip.iproute2
}

# The .so files in iproute2-tc are modules, not traditional libraries
INSANE_SKIP:${PN}-tc = "dev-so"

#INSANE_SKIP:${PN} = "installed-vs-shipped"
INSANE_SKIP:${PN} += " file-rdeps"
INSANE_SKIP:${PN}-devlink += " file-rdeps"
INSANE_SKIP:${PN}-genl += " file-rdeps"
INSANE_SKIP:${PN}-ifstat += " file-rdeps"
INSANE_SKIP:${PN}-ip += " file-rdeps"
INSANE_SKIP:${PN}-lnstat += " file-rdeps"
INSANE_SKIP:${PN}-nstat += " file-rdeps"
INSANE_SKIP:${PN}-rtacct += " file-rdeps"
INSANE_SKIP:${PN}-ss += " file-rdeps"
INSANE_SKIP:${PN}-tc += " file-rdeps"
INSANE_SKIP:${PN}-tipc += " file-rdeps"
INSANE_SKIP:${PN}-rdma += " file-rdeps"

IPROUTE2_PACKAGES =+ "\
    ${PN}-devlink \
    ${PN}-genl \
    ${PN}-ifstat \
    ${PN}-ip \
    ${PN}-lnstat \
    ${PN}-nstat \
    ${PN}-rtacct \
    ${PN}-ss \
    ${PN}-tc \
    ${PN}-tipc \
    ${PN}-rdma \
"

PACKAGE_BEFORE_PN = "${IPROUTE2_PACKAGES}"
RDEPENDS:${PN_DL} += "${PN_DL}-ip"
#RDEPENDS:${PN} += " iptables-morello-dev"
#PROVIDES:${PN} += " ${PN} ${PN}-dev"

FILES:${PN} = "\
  ${PURECAP_SYSROOT_DIR}${exec_prefix}/* \
  ${PURECAP_SYSROOT_DIR}${localstatedir}/* \
  ${PURECAP_SYSROOT_DIR}${sysconfdir}/* \
  ${PURECAP_SYSROOT_DIR}${base_sbindir}/* \
"

FILES:${PN}-tc = "${PURECAP_SYSROOT_DIR}${base_sbindir}/tc* \
                  ${PURECAP_SYSROOT_DIR}${libdir}/tc/*.so"
FILES:${PN}-lnstat = "${PURECAP_SYSROOT_DIR}${base_sbindir}/lnstat \
                      ${PURECAP_SYSROOT_DIR}${base_sbindir}/ctstat \
                      ${PURECAP_SYSROOT_DIR}${base_sbindir}/rtstat"
FILES:${PN}-ifstat = "${PURECAP_SYSROOT_DIR}${base_sbindir}/ifstat"
FILES:${PN}-ip = "\
  ${PURECAP_SYSROOT_DIR}{base_sbindir}/ip.${PN_DL} \
  ${PURECAP_SYSROOT_DIR}{sysconfdir}/iproute2 \
  ${PURECAP_SYSROOT_DIR}{exec_prefix}/* \
  ${PURECAP_SYSROOT_DIR}{localstatedir}/* \
  ${PURECAP_SYSROOT_DIR}{base_sbindir}/bridge \
  ${PURECAP_SYSROOT_DIR}{base_sbindir}/rtmon \
  ${PURECAP_SYSROOT_DIR}{base_sbindir}/routel \
"
FILES:${PN}-genl = "${PURECAP_SYSROOT_DIR}${base_sbindir}/genl"
FILES:${PN}-rtacct = "${PURECAP_SYSROOT_DIR}${base_sbindir}/rtacct"
FILES:${PN}-nstat = "${PURECAP_SYSROOT_DIR}${base_sbindir}/nstat"
FILES:${PN}-ss = "${PURECAP_SYSROOT_DIR}${base_sbindir}/ss"
FILES:${PN}-tipc = "${PURECAP_SYSROOT_DIR}${base_sbindir}/tipc"
FILES:${PN}-devlink = "${PURECAP_SYSROOT_DIR}${base_sbindir}/devlink"
FILES:${PN}-rdma = "${PURECAP_SYSROOT_DIR}${base_sbindir}/rdma"

ALTERNATIVE:${PN_DL}-ip = "${PURECAP_SYSROOT_DIR}${base_sbindir}/ip"
ALTERNATIVE_TARGET[ip] = "${PURECAP_SYSROOT_DIR}${base_sbindir}/ip.${BPN}"
ALTERNATIVE_LINK_NAME[ip] = "${PURECAP_SYSROOT_DIR}${base_sbindir}/ip"
ALTERNATIVE_PRIORITY = "100"

ALTERNATIVE:${PN_DL}-tc = "tc"
ALTERNATIVE_LINK_NAME[tc] = "${PURECAP_SYSROOT_DIR}${base_sbindir}/tc"
ALTERNATIVE_PRIORITY_${PN_DL}-tc = "100"

#do_package_qa[noexec] = "1"
EXCLUDE_FROM_SHLIBS = "1"
